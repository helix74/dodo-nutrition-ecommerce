---
description: Project context and handover — READ THIS FIRST for any task. Contains current state, completed work, architecture decisions, and next steps.
globs:
alwaysApply: true
---

# Dodo Nutrition — Project Handover Report

> **Last updated**: 2026-02-16
> **Version**: 1.4.0
> **Owner**: Mohamed Ali Jardak (Dali)
> **Repo**: github.com/helix74/dodo-nutrition-ecommerce

---

## Project Overview

Dodo Nutrition is a **Tunisian sports nutrition e-commerce platform** built with:

- **Next.js 16.1.6** (App Router, Turbopack)
- **Sanity v4.22.0** (CMS — Studio mounted at `/studio`)
- **Clerk** (Authentication)
- **Tailwind CSS + shadcn/ui** (Styling)
- **GROQ AI** (AI shopping assistant)
- **Resend** (Email notifications)

### Language Strategy

- **Headlines & CTAs**: Darija in Arabic script (e.g., "علاش جاي؟", "واش مازلت محيّر؟")
- **Body text**: French
- **This mix is intentional** — do NOT normalize to pure French or Arabic

---

## Current State (Post Spec 029)

### What's Complete

| Spec | Feature | Status |
|------|---------|--------|
| 001–007 | Core: cart, checkout (COD), product pages, UI unification | ✅ Done |
| 008 | Packs & Bundles (schema + queries + client) | ✅ Done |
| 009 | Reviews system (schema, admin panel, testimonials) | ✅ Done |
| 010 | Wishlist | ✅ Done |
| 011 | Email notifications (Resend) | ✅ Done |
| 012 | Enhancements | ✅ Done |
| 013 | UI design system | ✅ Done |
| 014 | Mega menu | ✅ Done |
| 015 | Homepage + shop improvements | ✅ Done |
| 016 | SEO optimization | ✅ Done |
| 017a–g | Homepage redesign (9-section architecture) | ✅ Done |
| 018 | Dataset cleanup & product import | ✅ Done |
| 019 | Homepage revision & UI polish | ✅ Done |
| 020 | Site revision phase 2 (animations, polish) | ✅ Done |
| 021 | Admin dashboard critical fixes (A1–A5) | ✅ Done |
| 022 | Admin analytics & BI (charts, KPIs, insights) | ✅ Done |
| 023 | Admin Pre-ERP MVP (suppliers, invoices, stock alerts) | ✅ Done |
| 024 | Tracking integration (GA4, Meta Pixel, CAPI) | ✅ Code done — awaiting env vars |
| 025 | Ciblex delivery integration | ✅ Code done — awaiting credentials |
| 026 | SEO & discovery (JSON-LD, sitemap, OG) | ✅ Done |
| 027 | Pre-launch features (upsell, packs client, motion) | ✅ Done |
| 028 | Testing infrastructure | ✅ Done |
| **029** | **Documentation audit** | ✅ Done |

### Database State (Sanity Production)

| Document Type | Count | Notes |
|---|---|---|
| Products | **119** | All clean, proper IDs, 0 broken refs |
| Categories | **10** | proteines, creatine, pre-workout, gainers, bruleurs, acides-amines, vitamines, boosters, barres-snacks, accessoires |
| Brands | **21** | All with ≥1 product |
| Suppliers | **0** | Schema ready, awaiting user input |
| Invoices | **0** | Schema ready, awaiting user input |
| Hero Slides | 1 | Active |
| Banners | 3 | Active |
| Packs | 0 | Awaiting user data (template at `data/template-packs.csv`) |
| Reviews | 0 | Ready for input |
| Orders | 0 | Clean slate |

### What Still Needs User Action

1. **Product prices & stock** — Update real prices, stock, featured flags in `data/products-database.csv` → re-import
2. **Product images** — Upload in Sanity Studio
3. **Pack data** — Provide CSV based on `data/template-packs.csv`
4. **Tracking env vars** — Set `GA_MEASUREMENT_ID`, `META_PIXEL_ID`, `META_ACCESS_TOKEN` in `.env.local`
5. **Ciblex credentials** — Set `CIBLEX_USER`, `CIBLEX_PASS` in `.env.local`
6. **Custom email domain** — Verify `@dodonutrition.tn` with Resend
7. **Domain name** — Point `dodonutrition.tn` to Vercel

---

## Architecture Quick Reference

### File Structure

```
app/
├── (app)/              → Public storefront
│   ├── page.tsx        → Homepage (9 sections, 10 parallel queries)
│   ├── shop/page.tsx   → Shop (filters, search, pagination)
│   ├── products/[slug] → Product detail (gallery, info, accordion, reviews, related)
│   ├── brands/[slug]   → Brand detail page
│   ├── categories/[slug] → Category detail page
│   ├── packs/page.tsx  → Packs listing with filtering/sorting
│   └── layout.tsx      → App shell (Clerk, SanityLive, Header, Footer, Cart, Chat)
├── (admin)/admin/      → Admin dashboard (JWT auth, not Clerk)
│   ├── page.tsx        → Dashboard (KPIs, charts, recent orders, stock alerts, AI insights)
│   ├── orders/         → Order management + detail pages
│   ├── inventory/      → Product inventory + detail editing
│   ├── suppliers/      → Supplier management
│   ├── invoices/       → Invoice management
│   └── reviews/        → Review moderation
├── studio/             → Sanity Studio (mounted at /studio)
├── api/                → API routes (checkout, reviews, AI chat, admin, cart-upsell, shipping)
└── sitemap.ts          → Dynamic sitemap.xml generation

sanity/
├── schemaTypes/        → 11 types: product, category, brand, pack, heroSlide, banner, review, order, customer, supplier, invoice
├── lib/client.ts       → Read + write Sanity clients
├── lib/live.ts         → SanityLive + sanityFetch
└── structure.ts        → Studio desk structure (Marketing → Catalogue → Commerce → Operations)

lib/
├── sanity/queries/     → 13 query files (products, categories, brands, packs, reviews, banners, hero, orders, customers, stats, analytics, suppliers, invoices)
├── constants/goals.ts  → Goal→category mapping (muscle, performance, seche, wellness)
├── constants/stock.ts  → LOW_STOCK_THRESHOLD = 5
├── actions/            → Server actions (cart, checkout, reviews, orders, admin-data, admin-mutations, admin-analytics, shipping)
├── shipping/           → Ciblex API client + gouvernorat zone pricing
├── tracking/           → GA4 events, Meta Pixel events, Meta CAPI server-side
├── store/              → Zustand stores (cart, chat)
└── data/megamenu.ts    → Header data fetching

components/
├── home/               → 9 homepage sections (HeroSection, GoalNavigator, FeaturedProducts, BannerSection, FeaturedPacks, CategoryShowcase, TestimonialsSection, BrandsMarquee, FinalCTA)
├── app/                → Shared app components (ProductCard, CartSheet, ChatSheet, CartUpsell, PacksClient, etc.)
├── admin/              → Admin components + widgets/ (charts, KPIs, stock alerts)
├── seo/                → JsonLd structured data component
├── tracking/           → GoogleAnalytics, MetaPixel, TrackViewContent
├── layout/             → TopBar, Footer
└── ui/                 → shadcn components + motion.tsx (DO NOT modify shadcn directly)

scripts/                → Data pipeline scripts (fix-products-csv, csv-to-ndjson, force-cleanup, export-products-csv)
data/                   → CSV files (raw, clean, export, templates)
specs/                  → Feature specifications (001–029)
```

### Key Patterns

- **GROQ queries**: All use `defineQuery()` from `next-sanity`, `SCREAMING_SNAKE_CASE` naming
- **Product IDs**: `product-{brand-slug}-{product-slug}` (prevents collisions)
- **Category IDs**: `category-{slug}` (e.g., `category-proteines`)
- **Brand IDs**: `brand-{slug}` (e.g., `brand-applied-nutrition`)
- **Goal navigation**: Maps goal IDs to category slug arrays in `lib/constants/goals.ts`
- **Sanity fetch**: Always use `sanityFetch()` from `sanity/lib/live.ts` (not raw client.fetch)
- **Dark theme**: Uses CSS vars (`bg-background`, `text-foreground`, `border-border`, `bg-dodo-yellow` for CTAs)
- **Tracking**: Unified event system in `lib/tracking/events.ts` — fires both GA4 + Meta Pixel; server-side CAPI via `lib/tracking/meta-capi.ts`
- **Shipping**: Ciblex API in `lib/shipping/ciblex.ts`; zone pricing via `lib/shipping/gouvernorats.ts`; server actions in `lib/actions/shipping.ts`
- **SEO**: JSON-LD via `components/seo/JsonLd.tsx`; sitemap at `app/sitemap.ts`; OG/Twitter meta in page-level `generateMetadata()`
- **Admin analytics**: Server actions in `lib/actions/admin-analytics.ts`; chart components in `components/admin/`; widget compositions in `components/admin/widgets/`
- **Animations**: Framer Motion wrappers in `components/ui/motion.tsx` (FadeIn, SlideUp, ScaleIn, StaggerContainer)

### Known Non-Issues (Don't Try to Fix)

- `No serverToken provided to defineLive` — Warning only, published content works fine
- 4 TypeGen warnings on paginated queries (`slicing must use constant numbers`) — Expected, queries work at runtime
- `fetch failed` / `ConnectTimeoutError` — User has intermittent internet, not a code issue

---

## What's Next: Launch Preparation

All **code** for v1.4.0 is feature-complete. The project is blocked on **user action items** only:

### Blocking Launch
1. **Product prices, stock, featured flags** — user must update CSV and re-import
2. **Product images** — user must upload in Sanity Studio
3. **Tracking env vars** — user must provide GA4 + Meta Pixel IDs
4. **Ciblex credentials** — user must provide API username/password
5. **Domain** — user must configure DNS for `dodonutrition.tn`

### Post-Launch Priorities
- Newsletter backend (Resend Audiences)
- TikTok Pixel integration
- Online payment (Flouci / Konnect)
- Search UX improvements (persistent search bar)
- Infinite scroll pagination on shop page
- Export features for admin (Excel/PDF reports)

---

## Working With This Project

### Commands

```bash
pnpm dev              # Start dev server (Turbopack)
npx tsc --noEmit      # TypeScript check
npx sanity schema extract  # Extract Sanity schema
npx sanity typegen generate --enforce-required-fields  # Generate types
pnpm build            # Production build
```

### Environment

- Sanity Project: `tivydqqm` / dataset: `production`
- All env vars in `.env.local` (DO NOT commit)
- Admin auth: separate JWT system (not Clerk)

### Speckit Workflow

The user follows a "speckit" methodology:
- Each feature gets a `specs/NNN-feature-name/` folder (001–029 complete)
- Contains: `spec.md` (main), `plan.md`, `tasks.md`, `verification.md`
- User calls the AI agent "Maestro" and expects structured, documented work
- User communicates in **Tunisian Darija** (mix of Arabic + French) — respond normally in English/French
- **Speckit skill**: Use the `speckit` skill (`.cursor/skills/speckit/SKILL.md`) for `/speckit.*` commands

### User Preferences

- Prefers comprehensive analysis before changes
- Wants explicit verification after each task
- Expects git commits with detailed messages
- Likes CSV exports for manual data review
- Values documentation (specs, plans, checklists)

---

## Agent Configuration

### Rules (`.cursor/rules/`)

| Rule | Scope | Purpose |
|------|-------|---------|
| `ProjectHandover.mdc` | Always | Project context, state, architecture |
| `Agents.mdc` | Always | Core coding standards, Sanity, GROQ |
| `TunisianContext.mdc` | Always | Language, currency, cultural context |
| `DodoDesignSystem.mdc` | Components/UI | Dark theme, colors, typography |
| `DodoEcommerce.mdc` | Cart/Checkout/Orders | E-commerce patterns |
| `NextjsPatterns.mdc` | App Router files | Next.js patterns |
| `GROQQueries.mdc` | Queries | GROQ query conventions |
| `SanitySchemas.mdc` | Schema files | Sanity schema patterns |
| `Performance.mdc` | Components/Config | Optimization targets |
| `AdminDashboard.mdc` | Admin files | Admin patterns |
| `AIChat.mdc` | Chat files | AI assistant patterns |
| `Shadcn.mdc` | On demand | shadcn/ui reference |
| `Clerk.mdc` | On demand | Clerk auth patterns |
| `sanityAppSDK.mdc` | On demand | Sanity App SDK |
| `sanityAppSDKTypegen.mdc` | On demand | TypeGen |

### Skills (`.cursor/skills/`)

| Skill | Trigger |
|-------|---------|
| `speckit` | `/speckit.*` commands, feature planning |
| `feature-development` | New feature implementation |
| `component-creation` | Creating React components |
| `sanity-data-pipeline` | Data import/export |
| `deployment-checklist` | Pre-deployment verification |
